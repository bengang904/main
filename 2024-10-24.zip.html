<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>html</title>
    <style>
        :root {
            --vscode-bg: #1e1e1e;
            --vscode-text: #ffffff;
        }

        * { box-sizing: border-box; }
        
        body, html {
            margin: 0; padding: 0;
            background-color: var(--vscode-bg);
            height: 100vh; width: 100vw;
            overflow: hidden;
        }

        #code-input {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 10px 10px 10px 25px;
            background-color: var(--vscode-bg);
            color: var(--vscode-text);
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre;
            tab-size: 4;
            border: none;
            outline: none;
            resize: none;
            overflow: auto;
        }

        .render-trigger {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background: #6e6e6e;
            color: #fbfbfb;
            border: 1px solid #444;
            padding: 8px 18px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            z-index: 10;
            opacity: 0.5;
            transition: 0.3s;
        }
        .render-trigger:hover { opacity: 1; background: #444; color: #fff; }
    </style>
</head>
<body>

<textarea id="code-input" spellcheck="false" placeholder="在此输入 HTML 代码..."></textarea>
<button class="render-trigger" onclick="runInNewTab()">Run Render</button>

<script>
    const input = document.getElementById('code-input');

    function safeB64Encode(str) {
        const bytes = new TextEncoder().encode(str);
        let binString = "";
        bytes.forEach((b) => binString += String.fromCharCode(b));
        return window.btoa(binString);
    }

    function safeB64Decode(str) {
        try {
            const binString = window.atob(str);
            const bytes = Uint8Array.from(binString, (m) => m.charCodeAt(0));
            return new TextDecoder().decode(bytes);
        } catch (e) { return ""; }
    }
    function updateUrl() {
        const content = input.value;
        const b64 = content.trim() ? safeB64Encode(content) : "";
        const newUrl = new URL(window.location.origin + window.location.pathname);
        
        if (b64) {
            newUrl.searchParams.set('code', b64);
        }

        window.history.replaceState(null, '', newUrl.toString());
    }
    function runInNewTab() {
        const content = input.value;
        if (!content.trim()) return;
        const b64 = safeB64Encode(content);
        const previewUrl = new URL(window.location.origin + window.location.pathname);
        previewUrl.searchParams.set('render', 'true');
        previewUrl.searchParams.set('code', b64);

        window.open(previewUrl.toString(), '_blank');
    }

    window.onload = function() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const isRender = params.get('render') === 'true';

        if (code) {
            const decodedCode = safeB64Decode(code);
            
            if (isRender) {
                document.open();
                document.write(decodedCode);
                document.close();
            } else {
                input.value = decodedCode;
            }
        }
    };

    input.addEventListener('input', updateUrl);

    input.onkeydown = function(e) {
        if (e.key === 'Tab') {
            e.preventDefault();
            const s = this.selectionStart;
            this.value = this.value.substring(0, s) + "\t" + this.value.substring(this.selectionEnd);
            this.selectionStart = this.selectionEnd = s + 1;
            updateUrl();
        }
    };
</script>

</body>
</html>
